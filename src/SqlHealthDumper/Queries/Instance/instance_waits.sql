SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
SET DEADLOCK_PRIORITY LOW;

WITH waits AS (
    SELECT
        wait_type,
        waiting_tasks_count,
        signal_wait_time_ms,
        wait_time_ms - signal_wait_time_ms AS resource_wait_ms
    FROM sys.dm_os_wait_stats
    WHERE wait_type NOT LIKE 'SLEEP%'
      AND wait_type NOT LIKE 'XE_%'
      AND wait_type NOT IN (
            'BROKER_EVENTHANDLER','BROKER_RECEIVE_WAITFOR','BROKER_TASK_STOP',
            'BROKER_TO_FLUSH','BROKER_TRANSMITTER','CHECKPOINT_QUEUE','CLR_AUTO_EVENT',
            'CLR_MANUAL_EVENT','DIRTY_PAGE_POLL','FT_IFTS_SCHEDULER_IDLE_WAIT',
            'HADR_FILESTREAM_IOMGR_IOCOMPLETION','LAZYWRITER_SLEEP','LOGMGR_QUEUE',
            'ONDEMAND_TASK_QUEUE','REQUEST_FOR_DEADLOCK_SEARCH','XE_TIMER_EVENT',
            'SLEEP_TASK','SLEEP_SYSTEMTASK','SQLTRACE_MESSAGE_QUEUE','WAITFOR',
            'WAITFOR_TASKSHUTDOWN','BROKER_CONNECTION_RECEIVE','DBMIRROR_EVENTS_QUEUE',
            'DISPATCHER_QUEUE_SEMAPHORE','QDS_CLEANUP_STALE_QUERIES_TASK_MAIN_LOOP_SLEEP',
            'QDS_PERSIST_TASK_MAIN_LOOP_SLEEP','HADR_CLUSAPI_CALL',
            'SOS_WORK_DISPATCHER','PWAIT_ALL_COMPONENTS_INITIALIZED','QDS_ASYNC_QUEUE',
            'SQLTRACE_INCREMENTAL_FLUSH_SLEEP','STARTUP_DEPENDENCY_MANAGER',
            'SQLTRACE_WAIT_ENTRIES','PREEMPTIVE_OS_FLUSHFILEBUFFERS','PREEMPTIVE_OS_FILEOPS',
            'PREEMPTIVE_XE_GETTARGETSTATE','PREEMPTIVE_OS_AUTHENTICATIONOPS')
)
SELECT TOP 10
    wait_type,
    waiting_tasks_count,
    resource_wait_ms,
    signal_wait_time_ms,
    CASE 
        WHEN SUM(resource_wait_ms) OVER () = 0 THEN 0
        ELSE resource_wait_ms * 100.0 / SUM(resource_wait_ms) OVER ()
    END AS percent_of_total
FROM waits
ORDER BY resource_wait_ms DESC;
